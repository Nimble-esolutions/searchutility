{% load static i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% trans "Search With AI - CC & RCS Maharashtra" %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="{% trans 'Commissioner for Cooperation and Registrar, Cooperative Societies, Maharashtra State, Pune' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'main/css/style.css' %}">
</head>
<body>

<!-- Top Utility Bar -->
<div class="bg-dark text-white small px-3 py-1">
  <div class="container d-flex flex-wrap justify-content-between align-items-center">
    
    <!-- Search -->
    <form class="me-3" role="search">
      <input type="text" value="{% trans 'Search Here' %}" maxlength="50"
             class="form-control form-control-sm" style="min-width: 180px;"
             onclick="this.value = (this.value === this.defaultValue) ? '' : this.value;">
    </form>

    <!-- Links + Language Toggle -->
    <div class="text-end">
      <a href="{% url 'login' %}" class="text-white text-decoration-none me-2">{% trans "Admin Login" %}</a> |
      <a href='https://sahakarayukta.maharashtra.gov.in/Site/Home/Index.aspx' class="text-white text-decoration-none me-2">{% trans "Home" %}</a> |
      <a href="#" class="text-white text-decoration-none me-2">{% trans "Contact Us" %}</a> |
      
      <!-- Language Toggle -->
      <form action="{% url 'set_language' %}" method="post" class="d-inline">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        {% if request.LANGUAGE_CODE == 'en' %}
          <!-- If English, show Marathi option -->
          <input type="hidden" name="language" value="mr">
          <button type="submit" class="btn btn-link btn-sm text-white p-0 m-0">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
        {% else %}
          <!-- If Marathi, show English option -->
          <input type="hidden" name="language" value="en">
          <button type="submit" class="btn btn-link btn-sm text-white p-0 m-0">English</button>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<!-- Header Section
<header style="background: url('{% static 'main/images/header-bg.jpg' %}') center/cover no-repeat; min-height: 130px;" class="text-white py-2">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-2 text-start">
        <img src="{% static 'main/images/logo2.png' %}" alt="{% trans 'Left Logo' %}" style="min-height: 90px;">
      </div>
      <div class="col-8 text-center text-dark">
        <h5 class="fw-bold mb-1">{% trans "Commissioner for Cooperation and Registrar," %}</h5>
        <h6 class="fw-bold mb-1">{% trans "Cooperative Societies (CC and RCS), Maharashtra State, Pune" %}</h6>
      </div>
      <div class="col-2 text-end">
        <img src="{% static 'main/images/logo1.png' %}" alt="{% trans 'Right Logo' %}" style="min-height: 90px;">
      </div>
    </div>
  </div>
</header>
-->
<!-- Header Section -->
<header style="
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    padding: 0;
    overflow: hidden;">
  <img src="{% static 'main/images/banner-opt-2-wotxt.png' %}" 
       alt="Banner" 
       style="width: 100%; height: auto; display: block;">
  <div class="text-center text-dark position-absolute">
    <h5 class="fw-bold mb-1">{% trans "Commissioner for Cooperation and Registrar,Cooperative Societies (CC and RCS), Maharashtra State, Pune" %}</h5>
    <h6 class="fw-bold mb-1">{% trans "A Platform to faciliate User Friendly AI Enabled Search" %}</h6>
    
  </div>
</header>




<!-- Navigation 
<nav class="navbar navbar-expand-lg navbar-dark" 
     style="background: url('{% static 'main/images/menuTopBg.png' %}') center/cover no-repeat;">
  <div class="container-fluid">
    
  </div>
</nav>
-->
<!-- Chat Section (Full Width) -->
<div class="container-fluid p-0">
  <div class="chat-container">
      <div id="chatMain"></div>

      <div class="chat-input">
          <input type="text" id="userQuery" placeholder="üí¨ {% trans 'Ask anything...' %}">
          <button id="sendBtn">{% trans "Send" %}</button>
      </div>
  </div>
</div>

<!-- Navigation 
<nav class="navbar navbar-expand-lg navbar-dark" 
     style="background: url('{% static 'main/images/menuTopBg.png' %}') center/cover no-repeat;">
  <div class="container-fluid">
    
  </div>
</nav>
-->
<!-- Footer -->
<footer class="bg-light py-2  border-top">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center">
      
      <!-- Left Side -->
      <div>
        <small>{% trans "¬© 2025 Sahakarayukta Website. All rights reserved." %}</small>
      </div>
      
      <!-- Right Side: Logos with links -->
      <div class="d-flex gap-3">
        <a href="http://india.gov.in/" target="_blank">
          <img src="{% static 'main/images/logoIndia1.jpg' %}" alt="Logo 1" height="20">
        </a>
        <a href="http://validator.w3.org/check?uri=referer" target="_blank">
          <img src="{% static 'main/images/valid-xhtml10.gif' %}" alt="Logo 2" height="20">
        </a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer" target="_blank">
          <img src="{% static 'main/images/vcss.gif' %}" alt="Logo 3" height="20">
        </a>
        <a href="https://mahait.org/" target="_blank">
          <img src="{% static 'main/images/MahaIT_Logo.png' %}" alt="Logo 4" height="40">
        </a>
      </div>

    </div>
  </div>
</footer>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const chatMain = document.getElementById('chatMain');
const sendBtn = document.getElementById('sendBtn');
const userQuery = document.getElementById('userQuery');

// Show welcome message
window.addEventListener("DOMContentLoaded", function(){
    const welcome = `{{ welcome_message|safe }}`;
    if(welcome) appendMessage(welcome, "gpt");
    
});

sendBtn.addEventListener('click', sendMessage);
userQuery.addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });

function sendMessage(){
    const query = userQuery.value.trim();
    if(!query) return;

    appendMessage(query, 'user');
    userQuery.value = '';

    const typingDiv = appendMessage('', 'gpt', true);
    typingDiv.classList.add('typing');
    typingDiv.innerHTML = `<span>‚Ä¢</span><span>‚Ä¢</span><span>‚Ä¢</span>`;

    const formData = new FormData();
    formData.append('query', query);

    fetch("{% url 'search_query' %}", {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        typingDiv.remove();
        if(data.answer){
            const gptDiv = appendMessage(data.answer, 'gpt');
            if(data.references && data.references.length > 0){
                const refDiv = document.createElement('div');
                refDiv.className = "references";
                refDiv.innerHTML = "<strong>üìö References:</strong>";
                data.references.forEach(ref => {
                    const card = document.createElement('div');
                    card.className = "ref-card";
                    card.innerHTML = `
                        <a href="${ref.url}" target="_blank">${ref.title}</a>
                        <small>${ref.folder} ‚Ä¢ ${ref.uploaded_at}</small>
                    `;
                    refDiv.appendChild(card);
                });
                gptDiv.appendChild(refDiv);
                chatMain.scrollTop = chatMain.scrollHeight;
            }
        } else if(data.error){
            appendMessage('‚ö†Ô∏è Error: ' + data.error, 'gpt');
        }
    })
    .catch(err => {
        typingDiv.remove();
        appendMessage('‚ö†Ô∏è Something went wrong. Please try again later.', 'gpt');
        console.error(err);
    });
}

function appendMessage(text, sender, isLoading=false){
    const div = document.createElement('div');
    div.className = sender === 'user' ? 'user-msg' : 'gpt-msg';
    div.innerHTML = text.replace(/\n/g, '<br>');
    chatMain.appendChild(div);
    chatMain.scrollTop = chatMain.scrollHeight;
    if(isLoading) return div;
    return div;
}
</script>

<style>
.chat-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    height: 80vh;
    padding: 15px;
    background: #f0f0f0; 
}
#chatMain {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 5px;
}
.user-msg {
    align-self: flex-end;
    background-color:#f7eee2;
    color: #000;;
    padding: 10px 15px;
    border-radius: 20px 20px 0 20px;
    max-width: 70%;
    word-wrap: break-word;
}
.gpt-msg {
    align-self: flex-start;
    background-color: #fff;
    padding: 10px 15px;
    border-radius: 20px 20px 20px 0;
    max-width: 100%;
    word-wrap: break-word;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    white-space: pre-line;
    font-family: 'Segoe UI', sans-serif;
}
.typing span {
    display: inline-block;
    animation: blink 1.2s infinite;
}
@keyframes blink {
    0%, 20% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
}
.chat-input {
    display: flex;
    gap: 10px;
    padding-top: 10px;
}
.chat-input input[type="text"] {
    flex: 1;
    border-radius: 25px;
    padding: 10px 15px;
    border: 1px solid #ccc;
}
.chat-input button {
    border-radius: 25px;
    padding: 10px 20px;
    background-color: #e97e15;
    color: #fff;
    border: none;
    cursor: pointer;
}
.chat-input button:hover {
    background-color: #e97e15;
}
.references {
    font-size: 0.85rem;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.ref-card {
    background: #f1f8e9;
    border-left: 4px solid #8bc34a;
    padding: 6px 10px;
    border-radius: 8px;
}
.ref-card a {
    color: #33691e;
    text-decoration: none;
    font-weight: 600;
}
.ref-card small {
    display: block;
    font-size: 0.75rem;
    color: #666;
}


</style>
</body>
</html>
