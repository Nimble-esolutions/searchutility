{% load static i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% trans "Search With AI - CC & RCS Maharashtra" %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="{% trans 'Commissioner for Co-operation and Registrar, Cooperative Societies, Maharashtra State, Pune' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'main/css/style.css' %}">
</head>
<body>

<!-- Top Utility Bar -->
<div class="bg-dark text-white small px-3 py-1">
  <div class="container d-flex flex-wrap justify-content-between align-items-center">
    <form class="me-3" role="search">
      <input type="text" value="{% trans 'Search Here' %}" maxlength="50"
             class="form-control form-control-sm" style="min-width: 180px;"
             onclick="this.value = (this.value === this.defaultValue) ? '' : this.value;">
    </form>

    <div class="text-end">
      <a href="{% url 'login' %}" class="text-white text-decoration-none me-2">{% trans "Admin Login" %}</a> |
      <a href='https://sahakarayukta.maharashtra.gov.in/Site/Home/Index.aspx' class="text-white text-decoration-none me-2">{% trans "Home" %}</a> |
      <a href="#" class="text-white text-decoration-none me-2">{% trans "Contact Us" %}</a> |
      <form action="{% url 'set_language' %}" method="post" class="d-inline">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        {% if request.LANGUAGE_CODE == 'en' %}
          <input type="hidden" name="language" value="mr">
          <button type="submit" class="btn btn-link btn-sm text-white p-0 m-0">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
        {% else %}
          <input type="hidden" name="language" value="en">
          <button type="submit" class="btn btn-link btn-sm text-white p-0 m-0">English</button>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<!-- Header Section -->
<header style="width: 100%; display: flex; align-items: center; justify-content: center; margin: 0; padding: 0; overflow: hidden;">
  <img src="{% static 'main/images/banner-opt-2-wotxt.png' %}" alt="Banner" style="width: 100%; height: auto; display: block;">
  <div class="text-center text-dark position-absolute">
    <h5 class="fw-bold mb-1">{% trans "AI Enabled Search"%}</h5>
    <h6 class="fw-bold mb-1">{% trans "Commssioner for Co-operation and Registrar,Co-operative Societies" %}</h6>
    
  </div>
</header>

<!-- Chat Section -->
<div class="container-fluid p-0">
  <div class="chat-container">

      <div id="chatMain"></div>

     

      <div class="chat-input">
         <img src="{% static 'main/images/Option-1 BOT.png' %}" alt="Ask Icon" style="height:65px;">
          <input type="text" id="userQuery" placeholder="üí¨ {% trans 'Ask your question...' %}">
          <button id="sendBtn">{% trans "Search" %}</button>
      </div>

      <small id="wordCounter" style="color: gray; font-size: 12px; display: block; margin-left: 10px; margin-top: 2px;">
        0/30 words
      </small>

      <!-- ‚úÖ Disclaimer -->
<div class="text-center " style="font-size: 13px; color: #666;">
    ‚ö†Ô∏è Sahkar AI can make mistakes. Check important info.
</div>

  </div>
</div>

<!-- Footer -->
<footer class="bg-light py-2  border-top">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <small>{% trans "¬© 2025 Sahakarayukta Website. All rights reserved." %}</small>
      </div>
      <div class="d-flex gap-3">
        <a href="http://india.gov.in/" target="_blank"><img src="{% static 'main/images/' %}" alt="Logo 1" height="20"></a>
        <a href="http://validator.w3.org/check?uri=referer" target="_blank"><img src="{% static 'main/images/' %}" alt="Logo 2" height="20"></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer" target="_blank"><img src="{% static 'main/images/' %}" alt="Logo 3" height="20"></a>
        <a href="https://mahait.org/" target="_blank"><img src="{% static 'main/images/.png' %}" alt="Logo 4" height="40"></a>
      </div>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const chatMain = document.getElementById('chatMain');
const sendBtn = document.getElementById('sendBtn');
const userQuery = document.getElementById('userQuery');

// Show welcome message
window.addEventListener("DOMContentLoaded", function(){
    const welcome = `{{ welcome_message|safe }}`;
    if(welcome) appendMessage(welcome, "gpt");
});

sendBtn.addEventListener('click', sendMessage);
userQuery.addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });

function sendMessage(){
    const query = userQuery.value.trim();
    if(!query) return;
    // üîπ Word limit check (30 words)
    const wordCount = query.split(/\s+/).length;
    if(wordCount > 30){
        appendMessage("‚ö†Ô∏è Your query is too long (max 30 words). Please shorten it.", "gpt");
        return;
    }

    appendMessage(query, 'user');
    userQuery.value = '';
    sendBtn.disabled = true;

    const typingDiv = appendMessage('', 'gpt', true);
    typingDiv.classList.add('typing');
    typingDiv.innerHTML = `<span>‚Ä¢</span><span>‚Ä¢</span><span>‚Ä¢</span>`;

    const formData = new FormData();
    formData.append('query', query);

    fetch("{% url 'search_query' %}", {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        typingDiv.remove();
        if(data.answer){
            typeEffect(data.answer, data.references || []);
        } else if(data.error){
            appendMessage('‚ö†Ô∏è Error: ' + data.error, 'gpt');
        }
    })
    .catch(err => {
        typingDiv.remove();
        appendMessage('‚ö†Ô∏è Something went wrong. Please try again later.', 'gpt');
        console.error(err);
    });
}

function appendMessage(text, sender, isLoading=false){
    const div = document.createElement('div');
    div.className = sender === 'user' ? 'user-msg' : 'gpt-msg';
    div.innerHTML = text.replace(/\n/g, '<br>');
    chatMain.appendChild(div);
    chatMain.scrollTop = chatMain.scrollHeight;
    if(isLoading) return div;
    return div;
}

// Typing effect for GPT answers
function typeEffect(text, references=[]) {
    const div = document.createElement('div');
    div.className = 'gpt-msg';
    chatMain.appendChild(div);

    let i = 0;
    let cursor = document.createElement("span");
    cursor.className = "cursor";
    div.appendChild(cursor);

    function typing() {
        if (i < text.length) {
            cursor.insertAdjacentHTML("beforebegin", text.charAt(i) === "\n" ? "<br>" : text.charAt(i));
            chatMain.scrollTop = chatMain.scrollHeight;
            i++;
            setTimeout(typing, 20);
        } else {
            cursor.remove();
            if (references.length > 0) {
                const refDiv = document.createElement('div');
                refDiv.className = "references";
                refDiv.innerHTML = "<strong>üìö References:</strong>";
                references.forEach(ref => {
                    const card = document.createElement('div');
                    card.className = "ref-card";
                    card.innerHTML = `
                        <a href="${ref.url}" target="_blank">${ref.title}</a>
                        <small>${ref.folder} ‚Ä¢ ${ref.uploaded_at}</small>
                    `;
                    refDiv.appendChild(card);
                });
                div.appendChild(refDiv);
            }
        }
    }
    typing();

  }
    const wordCounter = document.getElementById("wordCounter");

userQuery.addEventListener("input", function () {
    const words = this.value.trim().split(/\s+/).filter(w => w.length > 0);
    const count = words.length;

    wordCounter.textContent = `${count}/30 words`;

    if (count > 30) {
        wordCounter.style.color = "red";
        sendBtn.disabled = true;
    } else {
        wordCounter.style.color = "gray";
        sendBtn.disabled = (count === 0);
    }
});


</script>

<style>
.chat-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    height: 80vh;
    padding: 15px;
    background: #f0f0f0; 
}
#chatMain {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 5px;
}
.user-msg {
    align-self: flex-end;
    background-color:#f7eee2;
    color: #000;
    padding: 10px 15px;
    border-radius: 20px 20px 0 20px;
    max-width: 70%;
    word-wrap: break-word;
}
.gpt-msg {
    align-self: flex-start;
    background-color: #fff;
    padding: 10px 15px;
    border-radius: 20px 20px 20px 0;
    max-width: 100%;
    word-wrap: break-word;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    white-space: pre-line;
    font-family: 'Segoe UI', sans-serif;
}
.typing span {
    display: inline-block;
    animation: blink 1.2s infinite;
}
@keyframes blink {
    0%, 20% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
}
.cursor {
    display: inline-block;
    width: 2px;
    background: black;
    margin-left: 2px;
    animation: blink 1s infinite;
}
.chat-input {
    display: flex;
    gap: 10px;
    padding-top: 10px;
}
.chat-input input[type="text"] {
    flex: 1;
    border-radius: 25px;
    padding: 10px 15px;
    border: 1px solid #ccc;
}
.chat-input button {
    border-radius: 25px;
    padding: 10px 20px;
    background-color: #e97e15;
    color: #fff;
    border: none;
    cursor: pointer;
}
.chat-input button:hover {
    background-color: #e97e15;
}
.references {
    font-size: 0.85rem;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.ref-card {
    background: #f1f8e9;
    border-left: 4px solid #8bc34a;
    padding: 6px 10px;
    border-radius: 8px;
}
.ref-card a {
    color: #33691e;
    text-decoration: none;
    font-weight: 600;
}
.ref-card small {
    display: block;
    font-size: 0.75rem;
    color: #666;
}
</style>
</body>
</html>
